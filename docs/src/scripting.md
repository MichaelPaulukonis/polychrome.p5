# Scripting Module

The `scripting` module provides a powerful system for recording and playing back user actions and application state changes. This functionality is key for creating generative art, saving and sharing creations, and for debugging.

## Architecture

The module is divided into three main parts:

-   **`record.js`**: Handles the recording of actions and configuration changes into a script.
-   **`playback.js`**: Contains the logic for interpreting and playing back a recorded script.
-   **`diff.js`**: A utility for comparing two objects to find their differences, used to keep the recorded scripts concise.

---

## Recording (`record.js`)

The recording system captures two types of events: actions and configuration changes.

### `recordAction(props, bypass)`

This function is called to record a specific, discrete user action. The `props` object must contain an `action` property (e.g., `'paint'`, `'clearCanvas'`, `'macro'`) and any parameters associated with that action. The `bypass` flag can be used to temporarily disable recording.

### `recordConfig(params, bypass)`

This function is called whenever there's a potential change to the main `params` object (e.g., when the user interacts with the GUI). It uses the `diff` utility to compare the current `params` object with the previously recorded state. If there are any differences, it records a `'config'` action with a payload containing only the parameters that have changed. This prevents the script from becoming bloated with redundant configuration data.

### Other Functions

-   `output()`: Returns a copy of the current array of recorded actions.
-   `clear()`: Clears the recorded script.

---

## Playback (`playback.js`)

### `playback({ script, pct })`

This is a generator function that orchestrates the playback of a recorded script.

**Arguments:**

-   `script`: An array of action objects, as generated by the `record.js` module.
-   `pct`: The main application object (`pchrome`), which provides access to all the necessary drawing functions and parameters.

**Process:**

1.  The `playback` function first "unrolls" the script using a helper function. This expands any `repeat` actions into a simple, flat list of commands.
2.  It then iterates through the script, executing each command one by one using a `switch` statement on the `cmd.action` property.
3.  It can handle various actions, including:
    -   `paint`: Calls the main `draw` function.
    -   `config`: Merges the changed parameters into the local state for the playback.
    -   `macro`: Executes a named macro.
    -   Any other function on the `pct` object (e.g., `flip`, `mirror`).

Because it's a generator, the playback can be controlled externally, typically advancing one step per frame in the main `draw` loop.

---

## Diffing (`diff.js`)

This module provides a single default export, the `diff` function. It takes two JavaScript objects as input and returns a new object containing only the properties that are different between the two. It can recursively compare nested objects and also handles arrays and functions. This utility is crucial for the efficiency of the `recordConfig` function.
