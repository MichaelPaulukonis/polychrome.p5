# 16. Zonal Painting Implementation Plan (Revised)

This plan has been revised to align with the new off-screen rendering architecture introduced in Plan 15, which utilizes a high-resolution `drawingCanvas` for artwork and a separate `uiCanvas` for non-exported interface elements.

## 1. Vision & Core Concept

The goal is to confine painting operations to a specific, user-defined rectangular "zone." This feature will leverage the new layer architecture:

*   **Artwork Layer (`zone.graphics`):** A dedicated `p5.Graphics` buffer will be used for the active zone. All painting operations within the zone will occur on this buffer, which is then composited onto the main `drawingCanvas`. This maintains a relative coordinate system for painters.
*   **UI Feedback Layer (`uiCanvas`):** All visual feedback for the zone (selection rectangles, borders) will be drawn exclusively on the `uiCanvas`. This ensures that UI elements are never saved as part of the final artwork.
*   **Synchronization:** The zone's graphics buffer will be kept in sync with the main `drawingCanvas` to provide an intuitive and seamless user experience when activating, deactivating, and creating zones.

## 2. State Management (`sketch.js`)

**✅ COMPLETE**

```javascript
// Zonal Painting State
let zone = null; // Stores { x, y, width, height, graphics }
let zoneStartPos = null;

// In globals object for reactivity with GUI
globals.zoneExists = false;
globals.isDefiningZone = false;
globals.isZoneActive = false;
```

## 3. Lifecycle & UI Flow

**✅ COMPLETE**

1.  **Initiation (Click "Define Zone"):**
    *   `globals.isDefiningZone` is set to `true`.

2.  **Definition (Mouse Drag):**
    *   `mousePressed`: Captures scaled start coordinates in `zoneStartPos`.
    *   `mouseDragged`: Draws a dashed preview rectangle on the `uiCanvas`.
    *   `mouseReleased`: Finalizes zone dimensions, creates `zone.graphics`, copies the underlying section of `layers.drawingCanvas` into it, and initializes the color mode. Sets `globals.isDefiningZone = false`, `globals.isZoneActive = true`, and `globals.zoneExists = true`.

3.  **Painting (When `isZoneActive`):**
    *   Drawing is redirected to `zone.graphics` with translated coordinates.
    *   The click must be within the zone's bounds.
    *   After each paint operation, `zone.graphics` is drawn onto `layers.drawingCanvas` to commit the changes.
    *   A solid border is drawn on the `uiCanvas` for visual feedback.

4.  **Activation/Deactivation (Toggle Button):**
    *   **Deactivate:** `globals.isZoneActive` becomes `false`. Painting targets `layers.drawingCanvas`. The zone's border on `uiCanvas` becomes dashed. The `zone` object and its graphics are preserved.
    *   **Reactivate:** `globals.isZoneActive` becomes `true`. The underlying area from `layers.drawingCanvas` is copied back into `zone.graphics` to sync any intermediate changes. The border becomes solid.

5.  **Clearing (Click "Clear Zone"):**
    *   `zone.graphics.remove()` is called to prevent memory leaks.
    *   `zone` is set to `null`, and `globals.isZoneActive` and `globals.zoneExists` are set to `false`.
    *   The artwork previously in the zone remains on the `drawingCanvas`.

## 4. Implementation Steps

**✅ 1. `sketch.js` State:** State variables have been added.

**✅ 2. `sketch.js` `draw()` Loop:** The `draw()` loop now renders the zone's border and definition preview on the `uiCanvas`.

**✅ 3. `sketch.js` Drawing Dispatch:** The `standardDraw` function now correctly dispatches drawing to the zone's graphics buffer.

**✅ 4. Painter Modifications:** All drawing mode painters have been refactored to accept a `target` graphics object.

**✅ 5. GUI (`gui.js`):** GUI controls for defining, clearing, and toggling the zone have been added.

**✅ 6. Color System Refactoring:** The `color-system.js` module has been refactored to be context-aware, accepting a `layer` argument in its functions.

## 5. Revised Testing Strategy

*   **Unit Tests:**
    *   ✅ Verify coordinate translation logic.
    *   ✅ Test state management functions for creating, toggling, and clearing the zone.
    *   ✅ **Add a new test to assert the synchronization between `layers.drawingCanvas` and `zone.graphics` on creation and reactivation.**

*   **E2E Tests:**
    *   **Zone Definition:** Verify the dashed preview on `uiCanvas` and that the final border is **not** saved with the artwork.
    *   **Confined Painting:** Verify drawing is restricted to the zone and correctly composites over existing artwork.
    *   **Deactivation/Reactivation:** Test that changes made to the main canvas while the zone is inactive are correctly reflected underneath new drawings when the zone is reactivated.
    *   **Clearing:** Verify clearing the zone removes the border but leaves the artwork intact.