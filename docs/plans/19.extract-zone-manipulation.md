# 19. Extract Zone Manipulation Logic

This plan outlines the extraction of zone manipulation logic into a dedicated, testable module.

## 1. Vision & Core Concept

**Problem:** The current zone manipulation logic (`setZoneX`, `setZoneY`, `centerZone`, `isMouseInZone`) is tightly coupled with `sketch.js`. This makes it difficult to unit test these functions in isolation, especially due to `require.context` issues in the test environment.

**Vision:** To improve testability, modularity, and code organization by moving zone-specific manipulation functions into a new, independent module.

**Core Concept:** Create `src/zone/zone-manipulation.js` to house these functions. They will be refactored to accept their dependencies (like `zone`, `params`, `globals`, `p5`, `layers`) as arguments, rather than relying on global or closure variables from `sketch.js`.

## 2. State Management

*   The `zone` object itself, `globals`, `params`, `p5`, and `layers` are fundamental dependencies for zone manipulation. These will be passed as arguments to the functions in the new module.
*   `isDraggingZone` and `zoneStartPos` are internal state variables related to the *dragging process* (event handling), not the inherent properties of the zone. They will remain within `sketch.js`.

## 3. Rendering Pipeline

*   No direct changes to the rendering pipeline. The `draw()` loop in `sketch.js` will continue to use the `zone` object's properties (x, y, width, height, graphics) for rendering.
*   The functions in the new `zone-manipulation.js` module will *update* these properties, and these updates will be reflected in the subsequent `draw()` cycles.

## 4. UI Flow & Lifecycle

*   **GUI Interactions:** The existing GUI calls (`pct.setZoneX`, `pct.setZoneY`, `pct.centerZone`) from `gui.js` will remain unchanged. `sketch.js` will act as a thin wrapper, delegating these calls to the new module's functions.
*   **Mouse Events:** The `mousePressed`, `mouseDragged`, and `mouseReleased` functions in `sketch.js` will be updated to utilize the `isMouseInZone` helper and to update `zone.x` and `zone.y` during dragging by calling functions from the new module.

## 5. Implementation Steps

### Step 1: Create New Module File

*   Create the directory `src/zone/`.
*   Create the file `src/zone/zone-manipulation.js`.

### Step 2: Move and Refactor Functions

*   Move the following functions from `sketch.js` to `src/zone/zone-manipulation.js`:
    *   `isMouseInZone`
    *   `setZoneX`
    *   `setZoneY`
    *   `centerZone`
*   Refactor these functions to accept necessary dependencies (`zone`, `params`, `globals`, `p5`, `layers`) as explicit arguments.

### Step 3: Update `sketch.js`

*   Import the new functions from `src/zone/zone-manipulation.js`.
*   Modify the `pct` object's exposed methods (`pct.setZoneX`, `pct.setZoneY`, `pct.centerZone`) to call the corresponding functions from the new module, passing the required dependencies.
*   Update `p5.mousePressed` and `p5.mouseDragged` to call `isMouseInZone` and to update `zone.x`/`zone.y` using the new module's functions, passing the necessary dependencies.
*   Remove the original implementations of these functions from `sketch.js`.

## 6. Testing Strategy

### Unit Tests (`test/zone/zone-manipulation.test.js`)

*   ✅ Create the test file `test/zone/zone-manipulation.test.js`.
*   ✅ Mock all external dependencies (`zone`, `params`, `globals`, `p5`, `layers`) for isolated testing.
*   ✅ **`isMouseInZone`:** Test with various mouse positions (inside, outside, on edges) relative to a mocked zone.
*   ✅ **`setZoneX` / `setZoneY`:** Test that `zone.x` and `zone.y` are correctly updated when these functions are called.
*   ✅ **`centerZone`:** Test that the zone's `x` and `y` coordinates are correctly calculated and updated to center the zone on the canvas.
*   ✅ **Dragging Logic:** Test the core logic for updating `zone.x` and `zone.y` based on `dx` and `dy` (this will be part of the `mouseDragged` logic, but the core calculation can be tested in isolation if extracted).

## 7. Risks & Mitigation

*   **Risk:** Introducing new bugs due to refactoring and changes in dependency passing.
    *   **Mitigation:** Thorough unit testing of the new module, coupled with existing integration and e2e tests to catch regressions.
*   **Risk:** Incorrectly passing dependencies to the new functions.
    *   **Mitigation:** Careful review of function signatures and call sites. Leverage IDE features for parameter hints.

## 8. Dependencies

*   Existing `zone` object structure.
*   `p5.js` instance (for `p5.mouseX`, `p5.mouseY`, `p5.keyIsDown`, `p5.ALT`).
*   `layers` object (for `layers.scaleFactor`).
*   `globals` object (for `globals.zoneExists`, `globals.isZoneActive`).
*   `params` object (for `params.width`, `params.height`).
