# 17. Non-Destructive Zonal Painting

This plan outlines the evolution of the zonal painting feature into a non-destructive layer system, enabling transformations and other manipulations of the zone's content before committing it to the main drawing canvas.

## 1. Vision & Core Concept

The current zonal painting implementation is destructive. Each paint operation within the zone is immediately composited onto the main `drawingCanvas`. This proposal refactors the zone to be a true off-screen layer.

*   **Non-Destructive Zone Layer:** The `zone.graphics` object will function as an independent, non-destructive layer. Painting operations will be confined to this layer, and it will be rendered *over* the `drawingCanvas` in the main `draw()` loop, but not merged until a specific "commit" or "flatten" action is triggered.
*   **Transformations:** With the zone as a separate layer, we can apply canvas transformations (flip, rotate, mirror, etc.) to `zone.graphics` without affecting the underlying `drawingCanvas`.
*   **UI Feedback:** The `uiCanvas` will continue to provide visual feedback for the zone's state (e.g., borders, transformation handles).
*   **Synchronization:** The `zone.graphics` will be initialized with content from the `drawingCanvas` when created. A new "commit" action will merge the zone's content down to the `drawingCanvas`.

## 2. State Management (`sketch.js`)

The existing state variables will be retained, with the addition of a state to track transformations.

```javascript
// Zonal Painting State
let zone = null; // Stores { x, y, width, height, graphics, transformState }
let zoneStartPos = null;

// In globals object for reactivity with GUI
globals.zoneExists = false;
globals.isDefiningZone = false;
globals.isZoneActive = false;
```

The `zone` object will be extended to include a `transformState` object, which will store rotation, scale, and translation information for the zone.

## 3. Rendering Pipeline (`p5.draw()`)

The rendering pipeline in `p5.draw()` will be updated to handle the non-destructive zone layer.

1.  Draw the main `drawingCanvas`.
2.  If a zone exists (`globals.zoneExists`), apply its transformations (`zone.transformState`) and then draw `zone.graphics` on top of the main canvas.
3.  Draw the `uiCanvas` for borders and other feedback.
4.  Clear the `uiCanvas`.

This ensures that the zone's content is visually present and transformed correctly without being permanently merged into the main artwork.

## 4. UI Flow & Lifecycle

The UI flow will be modified to incorporate the new non-destructive workflow.

1.  **Initiation & Definition:** Unchanged.
2.  **Painting:** When `isZoneActive`, all drawing is redirected to `zone.graphics`. The `drawingCanvas` is *not* modified.
3.  **Transformations:** New UI controls and hotkeys will be added to apply transformations to `zone.graphics`. These will update `zone.transformState` and trigger a redraw.
4.  **Committing/Flattening (New Action):** A new "Commit Zone" button/action will merge `zone.graphics` onto `layers.drawingCanvas` at its current transformed position. After committing, the zone can either be cleared or remain active for further painting.
5.  **Activation/Deactivation:**
    *   **Deactivate:** The zone's content and transformations are preserved. The zone is simply not rendered.
    *   **Reactivate:** The zone is rendered again with its preserved content and transformations.
6.  **Clearing:** `zone.graphics.remove()` is called, and the `zone` object is cleared. The `drawingCanvas` remains untouched.

## 5. Implementation Steps

### Step 1: Update `sketch.js` for Non-Destructive Rendering

*   Modify the `draw()` loop to render `zone.graphics` as a separate layer with transformations.
*   Remove the line in `standardDraw` that composites `zone.graphics` onto `layers.drawingCanvas` after each paint operation.

### Step 2: Implement Zone Transformations

*   Extend the `zone` object to include a `transformState`.
*   Create new functions in `canvas-transforms.js` that specifically target `zone.graphics` and update `zone.transformState`.
*   Add new GUI controls and hotkeys to trigger these zone transformations.

### Step 3: Add "Commit Zone" Functionality

*   Create a new `commitZone` function in `sketch.js`. This function will:
    *   Apply the final transformations to `zone.graphics`.
    *   Draw the transformed `zone.graphics` onto `layers.drawingCanvas`.
    *   Optionally clear the zone or leave it active for further edits.
*   Add a "Commit Zone" button to the GUI.

### Step 4: Update `undo` System

*   The `undo` system currently snapshots the `drawingCanvas`. This will need to be extended to also snapshot the state of the `zone` object (including `zone.graphics` and `zone.transformState`) when a zone is active.
*   When undoing/redoing, both the `drawingCanvas` and the `zone` state must be restored.

## 6. Testing Strategy

*   **Unit Tests:**
    *   Verify that zone transformations update `zone.transformState` correctly.
    *   Test the `commitZone` function to ensure it correctly merges the zone's content.
    *   Test the updated `undo` system to ensure it correctly snapshots and restores the zone's state.
*   **E2E Tests:**
    *   Verify that transformations are applied only to the zone.
    *   Test the full lifecycle: create, paint, transform, commit, clear.
    *   Verify that undo/redo works correctly with zonal painting and transformations.
    *   Ensure that saving the artwork only saves the `drawingCanvas` and does not include the uncommitted zone.
