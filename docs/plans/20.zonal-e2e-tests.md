# 20. Zonal Painting and Manipulation E2E Tests

## 1. Problem Statement

The current zonal painting and manipulation features lack comprehensive end-to-end test coverage, making it difficult to verify their functionality and prevent regressions in a real browser environment.

## 2. Requirements

- Verify core zonal painting functionality (definition, confined painting, activation/deactivation, clearing).
- Verify non-destructive zonal painting features (transformations, commit).
- Verify zone manipulation (dragging, moving via GUI, centering via GUI).
- Tests should run in a Playwright environment.
- Tests should interact with the GUI and canvas as a user would.
- Tests should assert on visual changes (screenshots) and application state.

## 3. Technical Approach

- Create a new e2e test file: `test/e2e/zonal-painting/zonal-painting-full.spec.js`.
- Utilize Playwright for browser automation.
- Leverage existing `canvas-utils.js` functions for common interactions (waiting for p5.js, simulating gestures, GUI clicks).
- Implement robust waits to ensure application state is ready before assertions.
- Use `page.evaluate` to inspect `window.pchrome` global state for assertions.
- Capture screenshots at key points for visual regression testing and manual inspection.

## 4. Implementation Steps

1. Create `docs/plans/20.zonal-e2e-tests.md` (this file).
2. Create `test/e2e/zonal-painting/zonal-painting-full.spec.js`.
3. Implement tests for Plan 16 (Zonal Painting):
    - Zone Definition and Visual Feedback (no border saved).
    - Confined Painting (inside and outside zone).
    - Deactivation/Reactivation.
    - Clearing Zone.
4. Implement tests for Plan 17 (Non-Destructive Zonal Painting):
    - Apply Transformations (Flip, Mirror, Rotate) only to the zone.
    - Commit Zone content to main canvas.
    - (Note: Undo/Redo with Zone is a separate, more complex E2E test that might require further planning or be deferred if too complex for initial scope).
5. Implement tests for Plan 18 (Zone Dragging, Moving, and Centering):
    - Dragging the zone.
    - Moving the zone via GUI inputs.
    - Centering the zone via GUI button.
6. Ensure all tests use robust waits (e.g., `waitForP5Ready`, `waitForNuxtReady`, `waitForZoneReady`, `page.waitForSelector`).
7. Use `setParameter` for GUI input interactions.
8. Avoid using `.skip` tests as examples; refer to `test/e2e/ui/basic-interaction.spec.js` for good patterns.

## 5. Testing Strategy

- **E2E Tests:** All tests will be end-to-end, simulating user interactions in a real browser environment.
- **Assertions:**
    - Application state assertions (`page.evaluate` on `window.pchrome.globals` and `window.pchrome.zone`).
    - Visual assertions (screenshots at key steps for manual review and potential future visual regression).
    - Canvas content assertions (`canvasHasContent`, `getCanvasData`) where applicable.
- **Environment:** Playwright.

## 6. Risks & Mitigation

- **Timing Issues:** Playwright tests are prone to timing issues. Mitigation: Extensive use of `waitForFunction`, `waitForSelector`, and `waitForTimeout` (sparingly, only when other waits are insufficient).
- **GUI Element Locators:** QuickSettings GUI elements can be tricky to locate reliably. Mitigation: Use robust locators (e.g., `:has-text()`, `input[value=""]`) and `page.waitForSelector` before interaction.
- **Zone Object Initialization:** The `window.pchrome.zone` object might not be immediately available. Mitigation: Implement a dedicated `waitForZoneReady` helper function.

## 7. Dependencies

- Playwright test runner.
- Existing `canvas-utils.js` utility functions.
- Fully implemented zonal painting and manipulation features in the application.
